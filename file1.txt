Some code from John
Amy's changes
